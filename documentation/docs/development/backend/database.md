# Database
## Schema definitions
The database tables used by the FastAPI backend are all defined using SQLAlchemy. The table models are stored in `backend/app/db/models.py`.

## Alembic
### Creating revisions
The models are applied to the database using [Alembic](https://alembic.sqlalchemy.org/en/latest/). Whenever you make any changes to the database models, you will need to generate a new Alembic "revision". You can use the `bin/db-revision.sh` script to help create a new revision after you've made some changes to the database models:

```
bin/db-revision.sh "Some short note"
```
This script uses Alembic's "autogenerate" feature to create what it thinks is the correct database migration script for the changes you made.

Autogenerate is [not always perfect](https://alembic.sqlalchemy.org/en/latest/autogenerate.html#what-does-autogenerate-detect-and-what-does-it-not-detect), so you should **always** verify the migration script it creates before committing it to the repo (and applying it in production) to make sure what will be applied to the database is correct. 

The migration scripts can be found in `backend/db/migrations/versions/`. An example migration script for creating the "tag" database table is shown below:

```python
"""Initial revision

Revision ID: 03fe4895893f
Revises: 
Create Date: 2021-04-16 21:08:29.237142
"""

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic
revision = '03fe4895893f'
down_revision = None
branch_labels = None
depends_on = None

def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('tag',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_tag_id'), 'tag', ['id'], unique=False)
    # ### end Alembic commands ###

def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_tag_id'), table_name='tag')
    op.drop_table('tag')
    # ### end Alembic commands ###
```

This script shows you what it will do when you issue the "upgrade" command to the database as well as if you need to revert and issue the "downgrade" command. You can manually edit this migration script if something is incorrect.

### Applying revisions
Once you have a new revision you'd like to apply to the database, you can either use the `bin/reset-dev-container.sh` script to rebuild your entire development environment (which will automatically apply the Alembic database revisions), or you can use the `bin/db-upgrade.sh` script to apply the revisions without erasing and rebuilding the development environment.